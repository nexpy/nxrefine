
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Introduction &#8212; NXRefine 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installation" href="installation.html" />
    <link rel="prev" title="NXRefine" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="NXRefine"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Introduction</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<p><em>NXRefine</em> implements a complete workflow for both data acquisition and
reduction of single crystal x-ray scattering collected by the sample
rotation method. The package generates a three-dimensional mesh of
scattering intensity, <em>i.e.</em>, S(<strong>Q</strong>), which can be used either to
model diffuse scattering in reciprocal space or to transform the data to
produce three-dimensional pair-distribution-functions (PDF), which
represent the summed probabilities of all possible interatomic vectors
in real space, <em>i.e.</em>, Patterson maps. If the Bragg peaks are eliminated
before these transforms, using a process known as ‘punch-and-fill,’ only
those probabilities that deviate from the average crystalline structure
are retained. The final stage of the <em>NXRefine</em> workflow is to generate
such 3D-ΔPDF maps.</p>
<p>The uncompressed raw data from such measurements comprise tens (and
sometimes hundreds) of gigabytes, which are often collected in under 30
minutes. The speed of data collection allows such measurements to be
repeated multiple times as a function of a parametric variable, such as
temperature. Such data needs to be transformed into reciprocal space as
quickly as it is measured, so that scientists can inspect the results
before a set of scans is complete. For this reason, the <em>NXRefine</em>
workflow is designed to be run automatically once an initial refinement
of the sample orientation has been determined.</p>
<p><em>NXRefine</em> is currently in use on Sector 6-ID-D at the Advanced Photon
Source and the QM2 beamline at CHESS, and is under active development at
other facilities.</p>
<div class="section" id="experimental-geometry">
<h2>Experimental Geometry<a class="headerlink" href="#experimental-geometry" title="Permalink to this headline">¶</a></h2>
<p><em>NXRefine</em> is designed for experiments, in which the sample is placed in
a monochromatic x-ray beam and rotated continuously about an axis that
is approximately perpendicular to the beam. Images are collected on an
area detector placed in transmission geometry behind the sample. Many
area detectors consist of a set of chips with small gaps between them,
so sample rotation scans are often repeated multiple times (typically
three) with small detector translations between each one to fill in
these gaps. However, it is also possible to accomplish this just by
adjusting the orientation of the rotation axis itself. <em>NXRefine</em>
reduces the data independently for each rotation scan before merging
them to create a single 3D data volume.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="_images/experimental-geometry.png"><img alt="_images/experimental-geometry.png" src="_images/experimental-geometry.png" style="width: 80%;" /></a>
<p class="caption"><span class="caption-text"><em>Experimental geometry used in NXRefine.</em></span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The sample is at the center of a χ-circle, which can be rotated about
the horizontal or vertical axes by θ or ω, respectively. When θ = ω = 0,
the χ-circle is perpendicular to the incident beam. During a scan, the
sample is rotated about the Φ-axis, which is vertical when χ = θ = 0.
However, the Φ-axis can be reoriented by adjusting any of the other
three angles. The figure shows the configuration in use on Sector
6-ID-D, in which the Φ-axis is horizontal, with θ = ω = 0 and χ = -90°.
The dotted lines show the orientation of the Φ-axis with ω = ±15°;
rotating ω between Φ-rotation scans can be used to improve the quality
of the merged data, for reasons that are explained in a later section.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This geometry is equivalent to the four-circle geometry
defined by H. You [see Fig. 1 in J. Appl. Cryst. <strong>32</strong>, 614
(1999)], with θ and ω corresponding to η and μ, respectively.
At present, <em>NXRefine</em> assumes that the two angles coupled to
the detector (δ and ν in You’s paper), are fixed to 0°, with
detector misalignments handled by the yaw and pitch angles
refined in powder calibrations.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In earlier versions of <em>NXRefine</em>, θ was called the
goniometer pitch angle, since it corresponds to a tilting
or pitch of the goniometer’s χ-circle about the horizontal
axis. It is still referred to as ‘gonpitch’ in CCTW, the
C++ program called by <em>NXRefine</em> to transform the detector
coordinates to reciprocal space.</p>
</div>
<p><em>NXRefine</em> uses the following conventions to define a set of Cartesian
coordinates as laboratory coordinates when all angles are set to 0.</p>
<ul class="simple">
<li><p>+X<sub>lab</sub>: parallel to the incident beam.</p></li>
<li><p>+Z<sub>lab</sub>: parallel to the (usually vertical) axis connecting the
base of the χ-circle to the sample when χ = θ = 0.</p></li>
<li><p>+Y<sub>lab</sub>: defined to produce a right-handed set of coordinates.</p></li>
</ul>
<p>In addition to defining the sample orientation, it is necessary to
relate the pixel coordinates of the detector to the instrument
coordinates. Assuming the pixels form a rectangular two-dimensional
array, the detector’s X-axis corresponds to the fastest-changing
direction, which is normally horizontal, so that the orthogonal Y-axis
is vertical. The two coordinate systems are then related by:</p>
<blockquote>
<div><div class="line-block">
<div class="line">+X<sub>det</sub> = -Y<sub>lab</sub>, +Y<sub>det</sub> = +Z<sub>lab</sub>,
and +Z<sub>det</sub> = -X<sub>lab</sub></div>
</div>
</div></blockquote>
<p>This is discussed in more detail in the next section.</p>
</div>
<div class="section" id="sample-orientation">
<h2>Sample Orientation<a class="headerlink" href="#sample-orientation" title="Permalink to this headline">¶</a></h2>
<p>To transform data collected in this experimental geometry, it is
necessary to determine an orientation matrix using Bragg peaks measured
in the course of the sample rotation. With high-energy x-rays, the area
detector covers reciprocal space volumes that can exceed
10×10×10Å<sup>3</sup>. Depending on the size of the crystal unit cell,
such volumes contain hundreds, if not thousands, of Brillouin Zones.
<em>NXRefine</em> has a peak-search algorithm for identifying all the peaks
above a certain intensity threshold, which are then used to generate an
orientation matrix, <span class="math notranslate nohighlight">\(\mathcal{U}\)</span>, that is refined on a large
number of Bragg peaks.</p>
<p>Each peak is defined by its coordinates on the detector, <span class="math notranslate nohighlight">\(x_p\)</span> and
<span class="math notranslate nohighlight">\(y_p\)</span>, and the goniometer angles <span class="math notranslate nohighlight">\(\theta\)</span>, <span class="math notranslate nohighlight">\(\omega\)</span>,
<span class="math notranslate nohighlight">\(\chi\)</span>, and <span class="math notranslate nohighlight">\(\phi\)</span> of the diffractometer when the image was
collected. Once the orientation matrix has been determined, these
experimental coordinates can be converted into reciprocal space
coordinates, <span class="math notranslate nohighlight">\(\mathbf{Q}(h,k,l)\)</span>. The conversion is accomplished
through a set of matrix operations:</p>
<div class="math notranslate nohighlight">
\[\mathbf{Q}(h,k,l) = \mathcal{B}^{-1}\mathcal{U}^{-1}\mathcal{G}^{-1}
\frac{\left(\hat{\mathbf{d}}-\hat{\mathbf{x}}\right)}{\lambda}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{d}(x_{p}, y_{p})=\mathcal{D}\mathcal{O}^{-1}_{det}
\begin{pmatrix}{x_{p}-x_{c}}\\{y_{p}-y_{c}}\\0\end{pmatrix}-\mathcal{G}
\begin{pmatrix}{x_{s}-l_{sd}}\\{y_{s}}\\{z_{s}}\end{pmatrix}\end{split}\]</div>
<p>The <span class="math notranslate nohighlight">\(\mathcal{B}\)</span> matrix is defined by the lattice parameters of
the sample, as described by Busing and Levy in Acta Cryst. <strong>22</strong>, 457
(1967).  <span class="math notranslate nohighlight">\(\mathcal{G}\)</span> and <span class="math notranslate nohighlight">\(\mathcal{D}\)</span> describe two sets
of chained rotations:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\mathcal{G}(\theta,\omega,\chi,\phi)=\mathcal{R}^y(\theta)
\mathcal{R}^z(\omega)\mathcal{R}^x(\chi)\mathcal{R}^z(\phi)\\\mathcal{D}(\tau_{x},\tau_{y},\tau_{z})=\mathcal{R}^x(\tau_{x})
\mathcal{R}^y(\tau_{y})\mathcal{R}^z(\tau_{z})\end{aligned}\end{align} \]</div>
<p><span class="math notranslate nohighlight">\(\mathcal{R}^\alpha\)</span> are rotation matrices around axes,
<span class="math notranslate nohighlight">\(\alpha=x,y,z\)</span>, defined in the laboratory frame. The detector tilt
angles, <span class="math notranslate nohighlight">\(\tau_x\)</span>, <span class="math notranslate nohighlight">\(\tau_y\)</span>, and <span class="math notranslate nohighlight">\(\tau_z\)</span> are commonly
known as pitch, yaw, and roll, respectively.</p>
<p>All distances are defined in absolute units, <em>i.e.</em>, in the above
equations, the coordinates of the Bragg peaks, <span class="math notranslate nohighlight">\(x_p\)</span> and
<span class="math notranslate nohighlight">\(y_p\)</span>, and the beam center, <span class="math notranslate nohighlight">\(x_c\)</span> and <span class="math notranslate nohighlight">\(y_c\)</span> have been
multiplied by the pixel sizes. These coordinates are defined in the
detector frame in which the <em>x</em>-axis is the direction of the
fastest-moving pixel coordinates. By convention, the <em>x</em>-axis is
horizontal and the <em>y</em>-axis is vertical, <em>i.e.</em>, the origin of the pixel
array is in the lower-left corner. However, it is quite common for
detector images to be saved as TIFF or CBF files, in which the origin is
in the upper-left corner, <em>i.e.</em>, the <em>y</em>-axis points downward. To
accommodate this situation, and to handle other possible detector
orientations, the <span class="math notranslate nohighlight">\(\mathcal{O}\)</span> matrix converts between detector
and laboratory frames.</p>
<p>So, for example, for the conventional detector orientation,</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathcal{O} = \begin{pmatrix}0 &amp; -1 &amp; 0\\0 &amp; 0 &amp; 1\\-1 &amp; 0 &amp; 0\end{pmatrix}\end{split}\]</div>
<p>whereas, when the <em>y</em>-axis is flipped</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathcal{O} = \begin{pmatrix}0 &amp; -1 &amp; 0\\0 &amp; 0 &amp; -1\\1 &amp; 0 &amp; 0\end{pmatrix}\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, these matrices are defined in <em>NXRefine</em> settings
files by a single string, defining which laboratory axis are
parallel to the detector axes, <em>e.g.</em>, in the first example,
“-y +z -x”. It is possible to define detector orientation for
an arbitrary orientation, but this requires the (3x3) matrix
to be manually defined in the NeXus file.</p>
</div>
<p>The center of the sample, with respect to the goniometer center, is
given by <span class="math notranslate nohighlight">\(x_s\)</span>, <span class="math notranslate nohighlight">\(y_s\)</span>, and <span class="math notranslate nohighlight">\(z_s\)</span>, and the distance
from the goniometer center to the detector, at the point where the
incident beam would intersect, is <span class="math notranslate nohighlight">\(l_{sd}\)</span>. The incident beam
wavelength is <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<p>In the refinement procedure implemented by <em>NXRefine</em>, the orientation
matrix, <span class="math notranslate nohighlight">\(\mathcal{U}\)</span>, is generated by selecting two Bragg peaks,
whose (<em>h</em>, <em>k</em>, <em>l</em>) values are determined using initial estimates of
the instrument angles and the sample <em>d</em>-spacings. θ, ω, χ, and Φ are
initially set to their nominal motor angles, while the position and tilt
angles of the detector are estimated using a powder calibrant. It is
assumed that the space group and approximate lattice parameters are
known in advance, allowing an original estimate of the
<span class="math notranslate nohighlight">\(\mathcal{B}\)</span> matrix to be derived. Once the two peaks have been
selected, they are used to produce an initial estimate of
<span class="math notranslate nohighlight">\(\mathcal{U}\)</span>, from which all the other peaks are assigned (<em>h</em>,
<em>k</em>, <em>l</em>) indices. If these assignments are reasonable, then a large
number of peaks are used to refine both the instrumental and sample
parameters in order to minimize discrepancies between the calculated and
measured peak positions, allowing <span class="math notranslate nohighlight">\(\mathcal{U}\)</span> to be optimized.
If too few peaks are assigned by the initial peak selection, it is
necessary to select different peaks.</p>
<p>The refinement process, along with the tools that <em>NXRefine</em> provide to
facilitate peak assignments, are described in a later section.</p>
</div>
<div class="section" id="coordinate-transformation">
<h2>Coordinate Transformation<a class="headerlink" href="#coordinate-transformation" title="Permalink to this headline">¶</a></h2>
<p>Once the orientation matrix has been determined, the above equations are
used to transform the raw data into a three-dimensional grid in
reciprocal space. This is a numerically intensive operation that is
performed by a highly efficient multithreaded  C++ application, <em>Crystal
Coordinate Transformation Workflow</em> (<em>CCTW</em>), written by Guy Jennings
(APS).</p>
<p><em>CCTW</em> needs to be built from source, which is available on <a class="reference external" href="https://sourceforge.net/projects/cctw/">SourceForge</a>. <em>NXRefine</em> generates the
parameter file used by <em>CCTW</em> for each set of Φ-rotations, launches
the application, and links to the results. Once all the rotation scans
are processed, they are merged into a single reciprocal space grid. On
a multi-core system, it is possible to accomplish the complete
transformation process in less time than it takes to collect the data,
even though the raw data can exceed 100 GB in size.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Introduction</a><ul>
<li><a class="reference internal" href="#experimental-geometry">Experimental Geometry</a></li>
<li><a class="reference internal" href="#sample-orientation">Sample Orientation</a></li>
<li><a class="reference internal" href="#coordinate-transformation">Coordinate Transformation</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="index.html"
                          title="previous chapter">NXRefine</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="installation.html"
                          title="next chapter">Installation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/introduction.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="NXRefine"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Introduction</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Ray Osborn.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>