
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Experiments &#8212; NXRefine 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Experiments</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="experiments">
<h1>Experiments<a class="headerlink" href="#experiments" title="Permalink to this headline">¶</a></h1>
<p>Data that is processed by the NXRefine package are stored as HDF5 files
stored according to the <a class="reference external" href="http://www.nexusformat.org/">NeXus format</a>,
which is an international standard for the storage of x-ray and neutron
scattering data. NXRefine uses a hierarchical directory structure to
store both the experimental data, ingested from the raw data generated
on an x-ray beamline, and processed data generated by the data reduction
workflow. Scripts and plugins to the NeXpy GUI are used to facilitate
the creation of both the directory hierarchy and the NeXus files
themselves.</p>
<p>In the next section, we will describe the workflow used to both ingest
the raw data and transform it into reciprocal space coordinates and
pair-distribution-functions. In this section, we will describe the
directory framework, within which these processes function, and how
NeXpy can be used to initialize it.</p>
<div class="section" id="experiment-layout">
<h2>Experiment Layout<a class="headerlink" href="#experiment-layout" title="Permalink to this headline">¶</a></h2>
<p>An ‘experiment’ in NXRefine comprises measurements on a set of samples
that are logically grouped together, often because they are performed
within a specific time period and/or share calibration files. At
synchrotron x-ray facilities, it is common to schedule all the
measurements associated with a particular proposal together, so they
would be labelled by the proposal number and/or run cycle. For example,
on beamline 6-ID-D at the Advanced Photon Source, measurements resulting
from Proposal No. GUP-75969 may be scheduled in a specific run cycle,
say 23-1, and stored in, <em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">/data/6-id-d/GUP-75969-23-1</span></code>.</p>
<p>In NXRefine, it is assumed that all the files associated with a
particular experiment are stored in a single directory, <em>i.e.</em>, in the
APS example above, <code class="docutils literal notranslate"><span class="pre">GUP-75969-23-1</span></code>. This directory should contain
sub-directories that conform to a particular layout, which store files
such as calibration files (stored in the directory <code class="docutils literal notranslate"><span class="pre">calibrations</span></code>),
NeXus files containing measurement templates (stored in
<code class="docutils literal notranslate"><span class="pre">configurations</span></code>), settings and log files (stored in <code class="docutils literal notranslate"><span class="pre">tasks</span></code>), and a
set of directories containing the data from one or more samples measured
at one or more values of a parametric variable (usually temperature).</p>
<p>Here is the structure of a possible experiment directory. Most of the
names in this example are chosen to be generic, <em>i.e.</em>, they will be
different for every experiment. The only exceptions are the files in the
<code class="docutils literal notranslate"><span class="pre">tasks</span></code> directory, which are set automatically by NXRefine.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>experiment
└── tasks
    ├── nxdatabase.db
    ├── nxlogger.log
    ├── settings.ini
└── calibrations
    └── powder_calibration.tiff
└── configurations
    ├── configuration.nxs
└── sample1
    └── label1
        ├── sample1_100K.nxs
        └── 100K
            ├── f1.h5
            ├── f2.h5
            ├── f3.h5
            ├── f1_transform.nxs
            ├── f2_transform.nxs
            ├── f3_transform.nxs
            └── transform.nxs
        ├── sample1_200K.nxs
        └── sample1_300K.nxs
    └── label2
        └── sample1_300K.nxs
├── sample2
├── sample3
</pre></div>
</div>
<p>The aim of this directory structure is for all the data and metadata
required to analyze the results to be stored in an easily accessible
location, although not all files are required by NXRefine. For example,
the powder calibration files can be imported from any location.</p>
<p>If an instrument does not exclusively use NXRefine for its data
reduction, it is possible that there already exists a directory
containing the files that comprise an experiment as described above. To
avoid any interference with other instrument files, it is possible to
create the above directory structure within a sub-directory, usually
called <code class="docutils literal notranslate"><span class="pre">nxrefine</span></code>, of the instrument’s <code class="docutils literal notranslate"><span class="pre">experiment</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>experiment
└── nxrefine
    ├── tasks
    ├── calibrations
    ├── configurations
    ├── scripts
    ├── sample1
    └── sample2
    .
    .
    .
</pre></div>
</div>
<p>The name of this sub-directory is defined in the server settings, which
are defined in the Server section.</p>
</div>
<div class="section" id="experiment-sub-directories">
<h2>Experiment Sub-Directories<a class="headerlink" href="#experiment-sub-directories" title="Permalink to this headline">¶</a></h2>
<dl>
<dt><strong>tasks</strong></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">tasks</span></code> sub-directory contains a number of files used by
NXRefine to store default settings, workflow logs, and a MySQL
database for recording the status of each workflow component. The
files in this directory are created automatically by NXRefine and
should not be touched. NeXpy GUIs are used to inspect their
contents.</p>
</dd>
<dt><strong>calibrations</strong></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">calibrations</span></code> sub-directory is designed to contain either the
TIFF or CBF files generated by measurements of a calibrant powder,
or a file, usually with extension <code class="docutils literal notranslate"><span class="pre">.poni</span></code>, containing the
instrument parameters calibrated using the PyFAI module. The
workflow includes a GUI for performing PyFAI calibrations directly
on powder calibration image files, with the results stored in the
NeXus files (described below). The files don’t have to be stored in
this sub-directory, but if they are in another location, it is
recommended to copy them here for completeness. If the calibrations
have been performed by another package, the PONI parameters can be
imported directly from a PONI file.</p>
</dd>
<dt><strong>configurations</strong></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">configurations</span></code> sub-directory contains NeXus files that act
as templates when creating the files used to store the scan results.
These files contain scan parameters, such as the goniometer angles,
for one or more sample rotations, and are initialized by a NeXpy GUI
dialog.</p>
</dd>
<dt><strong>scripts</strong></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">scripts</span></code> sub-directory is not used directly by NXRefine, but
is created by the <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Experiment</span></code> dialog described below. It is
designed to store macros for use during an experiment.</p>
</dd>
<dt><strong>sample</strong></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">sample</span></code> sub-directories are typically named after a common
abbreviation or chemical formula of the measured sample (<em>e.g.</em>,
<code class="docutils literal notranslate"><span class="pre">TiSe2</span></code>). Within each sample directory are one or more directories
usually corresponding to different crystals, specified by unique
labels often provided by the crystal grower. It is common in these
experiments to screen a number of crystals before selecting one for
further measurements, so many of these directories only contain a
single scan.</p>
<p>Within each <code class="docutils literal notranslate"><span class="pre">label</span></code> directory, there are one or more directories
that are named after the parametric variable being modified between
each set of rotation scans, <em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">100K</span></code>. These <code class="docutils literal notranslate"><span class="pre">scan</span></code>
directories contain the raw data in HDF5 files, typically with
extension <code class="docutils literal notranslate"><span class="pre">.h5</span></code>. Each one of these <code class="docutils literal notranslate"><span class="pre">.h5</span></code> files contain the raw
data from a single rotation scan stacked into a single HDF5 array.
It is common to perform three sample rotations, which are then
stored in <code class="docutils literal notranslate"><span class="pre">f1.h5</span></code>, <code class="docutils literal notranslate"><span class="pre">f2.h5</span></code>, and <code class="docutils literal notranslate"><span class="pre">f3.h5</span></code>, but any number is
possible. The <code class="docutils literal notranslate"><span class="pre">scan</span></code> directories also contain other files produced
during the data reduction procedure, such as data transformed into
reciprocal space coordinates or pair-distribution functions.</p>
<p>For each of these <code class="docutils literal notranslate"><span class="pre">scan</span></code> directories, there is a corresponding
NeXus file that is named as, <em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">sample_scan.nxs</span></code>, where
<code class="docutils literal notranslate"><span class="pre">sample</span></code> must be the name of the <code class="docutils literal notranslate"><span class="pre">sample</span></code> directory and <code class="docutils literal notranslate"><span class="pre">scan</span></code>
should be the name of the directory containing the raw data.
These NeXus files contain external links to the much larger files
stored in the <code class="docutils literal notranslate"><span class="pre">scan</span></code> directories. By opening them, the user has
access to all the data and metadata associated with a particular
scan, since external links, if they are available, will appear to be
part of the file.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>External links are defined by the file name and internal path
to the required HDF5 field. If the file and/or field are not
available, the NeXus file can still be opened, but the
corresponding data cannot be viewed. The file name is stored
as a relative file path, so the NeXus file and a subset of
the files in the <code class="docutils literal notranslate"><span class="pre">scan</span></code> directory can be moved to another
location if, for example, access to the raw data is no
longer necessary.</p>
</div>
<div class="figure align-right" style="width: 40%">
<a class="reference internal image-reference" href="_images/instrument-settings.png"><img alt="_images/instrument-settings.png" src="_images/instrument-settings.png" style="width: 90%;" /></a>
</div>
</div>
<div class="section" id="experiment-setup">
<h2>Experiment Setup<a class="headerlink" href="#experiment-setup" title="Permalink to this headline">¶</a></h2>
<p>The experiment directory layout can be created automatically using GUI
dialogs in the NeXpy “Experiment” menu. Before using them, it is
important to have initialized the default instrument parameters using
the “Edit Settings” dialog of the NeXpy “Server” menu, or at the command
line using <code class="docutils literal notranslate"><span class="pre">nxsettings</span> <span class="pre">-i</span></code>.</p>
<p>The instrument settings provide information on the directories, in which
both the raw data and the NXRefine directory tree are located. It is
quite common for the raw data to be collected as a set of image files,
typically TIFF or CBF files. These are usually not stored in the
experiment directories described in the previous section, and may be in
read-only directories. To allow for the input of such files, NXRefine
defines two sets of paths; one to the ‘raw’ data and one to the NXRefine
(or ‘analysis’) directories. It is assumed that the experiment names,
<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">GUP-75969-23-1</span></code>, are the same in both locations, although
alternative methods of linking the ‘raw’ and ‘analysis’ paths could be
defined in the customized beamline classes described later.</p>
<p>For example, at CHESS, the ‘raw’ and ‘analysis’ paths are defined in
parallel directory trees as follows (with generic experiment names):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/nfs/chess/id4b                 /nfs/chess/id4baux
├── 2023-1                      ├── 2023-1
├── 2023-2                      ├── 2023-2
└── 2023-2                      └── 2023-2
    ├── experiment1                 ├── experiment1
    ├── experiment2                 ├── experiment2
    └── experiment3                 └── experiment3
        └── raw6M                       └── nxrefine
            ├── sample1                     ├── sample1
            ├── sample2                     ├── sample2
            └── sample3                     └── sample3
                └── label1                      └── label1
                    ├── 100                         ├── 100
                    ├── 200                         ├── 200
                    └── 300                         └── 300
</pre></div>
</div>
<p>Here is a list of instrument parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">source</dt>
<dd class="field-odd"><p>This is the name of the synchrotron source, at which the
instrument is located. This will be stored in the NeXus files
during the data reduction, but is not otherwise used.</p>
</dd>
<dt class="field-even">instrument</dt>
<dd class="field-even"><p>This is the name of the instrument. If a customized
beamline package is to be imported, this must correspond to
the instrument name used in the package.</p>
</dd>
<dt class="field-odd">raw_home</dt>
<dd class="field-odd"><p>This is the home directory, in which the experimental raw
data are stored. In the above example, this could be
<code class="docutils literal notranslate"><span class="pre">/nfs/chess/id4b/2023-3</span></code>.</p>
</dd>
<dt class="field-even">raw_path</dt>
<dd class="field-even"><p>This is the path within the experiment directory to the
sample directories. In the above example, this would be
<code class="docutils literal notranslate"><span class="pre">raw6M</span></code>.</p>
</dd>
<dt class="field-odd">analysis_home</dt>
<dd class="field-odd"><p>This is the home directory, in which the data are
analyzed. In the above example, this could be
<code class="docutils literal notranslate"><span class="pre">/nfs/chess/id4baux/2023-3</span></code>.</p>
</dd>
<dt class="field-even">analysis_path</dt>
<dd class="field-even"><p>This is the path within the experiment directory to the
NXRefine sub-directories. In the above example, this
would be <code class="docutils literal notranslate"><span class="pre">nxrefine</span></code>.</p>
</dd>
</dl>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Experiments</a><ul>
<li><a class="reference internal" href="#experiment-layout">Experiment Layout</a></li>
<li><a class="reference internal" href="#experiment-sub-directories">Experiment Sub-Directories</a></li>
<li><a class="reference internal" href="#experiment-setup">Experiment Setup</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="installation.html"
                          title="previous chapter">Installation</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/experiment.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Experiments</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Ray Osborn.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>