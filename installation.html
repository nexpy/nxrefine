
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Installation &#8212; NXRefine 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Experiments" href="experiment.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="experiment.html" title="Experiments"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>Currently, NXRefine must be installed from source by cloning the
<a class="reference external" href="https://github.com/nexpy/nxrefine">NXRefine Git repository</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/nexpy/nxrefine.git
</pre></div>
</div>
<p>Then use standard Python tools to build and/or install a distribution
from within the source directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m build  # build a distribution
$ python -m pip install .  # install the package
</pre></div>
</div>
<p>In the near future, NXRefine will be uploaded to the PyPI server so that
it can be installed without downloading the source code.</p>
<div class="section" id="required-libraries">
<h2>Required Libraries<a class="headerlink" href="#required-libraries" title="Permalink to this headline">¶</a></h2>
<p>The following packages are listed as dependencies.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Library</p></th>
<th class="head"><p>URL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NeXpy</p></td>
<td><p><a class="reference external" href="https://github.com/nexpy/nexpy/">https://github.com/nexpy/nexpy/</a></p></td>
</tr>
<tr class="row-odd"><td><p>cctbx-base</p></td>
<td><p><a class="reference external" href="https://cci.lbl.gov/cctbx_docs/">https://cci.lbl.gov/cctbx_docs/</a></p></td>
</tr>
<tr class="row-even"><td><p>pyfai</p></td>
<td><p><a class="reference external" href="https://pyfai.readthedocs.io/">https://pyfai.readthedocs.io/</a></p></td>
</tr>
<tr class="row-odd"><td><p>sqlalchemy</p></td>
<td><p><a class="reference external" href="https://docs.sqlalchemy.org/">https://docs.sqlalchemy.org/</a></p></td>
</tr>
<tr class="row-even"><td><p>psutil</p></td>
<td><p><a class="reference external" href="https://psutil.readthedocs.io/.io/">https://psutil.readthedocs.io/.io/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cctw">
<h2>CCTW<a class="headerlink" href="#cctw" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://sourceforge.net/projects/cctw/">CCTW</a> (Crystal Coordination
Transformation Workflow) is a C++ package written by Guy Jennings. It
is launched as a separate process by NXRefine, which uses the
experimental metadata to define the settings file used to define the
input and output grids. It has to be separately installed.</p>
</div>
<div class="section" id="user-support">
<h2>User Support<a class="headerlink" href="#user-support" title="Permalink to this headline">¶</a></h2>
<p>If you are interested in using this package, please contact Ray Osborn
(<a class="reference external" href="mailto:ROsborn&#37;&#52;&#48;anl&#46;gov">ROsborn<span>&#64;</span>anl<span>&#46;</span>gov</a>). Please report any bugs as a
<a class="reference external" href="https://github.com/nxrefine/nxrefine/issues">Github issue</a>, with
relevant tracebacks.</p>
</div>
<div class="section" id="initial-setup">
<h2>Initial Setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h2>
<p>In order to allow NXRefine to be used on machines with multiple users,
a directory is defined to store log files, task queues, and settings.
This directory can be initialized on the command line by the ‘nxserver’
command:</p>
<blockquote>
<div><p>$ nxserver -d /path/to/parent</p>
</div></blockquote>
<p>This will create a directory at <code class="docutils literal notranslate"><span class="pre">/path/to/parent/nxserver</span></code> containing
the files that are required by NXRefine server.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the supplied path already ends in <code class="docutils literal notranslate"><span class="pre">nxserver</span></code>, it will not
be appended.</p>
</div>
<p>All the files in the <code class="docutils literal notranslate"><span class="pre">nxserver</span></code> directory will have group read/write
permissions to allow them to be updated by multiple users in that group.</p>
<p>This also adds a hidden file to the home directory, containing the path
to the server directory, so that the server path can be read in future
login sessions. Each user should then issue the same command to store
the server directory in their own home directory. If the server
directory already exists, it is not touched. In principle, this only
needs to be run once, but it could be</p>
<p>NXRefine uses file-based locking to prevent corruption of data files.
This system is provided by the
<a class="reference external" href="https://nexpy.github.io/nexpy/">nexusformat package</a>, which defines
the directory to contain the lock files using the <code class="docutils literal notranslate"><span class="pre">NX_LOCKDIRECTORY</span></code>
environment variable. It is recommended that this directory be placed
within the server directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The NeXpy GUI has a settings file that can be used to define
the lock directory, but it is overridden by the environment
variable if it is defined. This allows system administrators
to set up a unique lock file directory for all their users.</p>
</div>
<div class="section" id="server-directory">
<h3>Server Directory<a class="headerlink" href="#server-directory" title="Permalink to this headline">¶</a></h3>
<p>Here is the structure of the <code class="docutils literal notranslate"><span class="pre">nxserver</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nxserver
├── nxserver.log
├── cpu1.log
├── cpu2.log
├── cpu3.log
├── settings.ini
├── nxcommand.sh
└── task_list
    ├── info
    └── q00000
└── locks
    ├── ...
    └── ...
</pre></div>
</div>
<p><strong>nxserver.log</strong></p>
<blockquote>
<div><p>This is a log file that records jobs submitted to the server queue.</p>
</div></blockquote>
<p><strong>cpu1.log</strong>, <strong>cpu2.log</strong>, …</p>
<blockquote>
<div><p>These are log files that contain the output of jobs running on the
server. The number depends on the number of simultaneous jobs that
are allowed on the server, which is defined by the settings file.</p>
</div></blockquote>
<p><strong>settings.ini</strong></p>
<blockquote>
<div><p>A file containing default settings used by the NXRefine package,
including server parameters, instrumental parameters, and parameters
used in the data reduction workflow. When a new experiment is set up,
a copy of these parameters is stored in the experiment directory (to
be described later), so that they can be customized if necessary.
These settings are described below.</p>
</div></blockquote>
<p><strong>nxsetup.sh</strong></p>
<blockquote>
<div><p>A shell script that could be used to initialize paths to the server
directory or environment variables used by NeXpy. This could be run
within a user’s <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file, or by other shell scripts used to
launch NXRefine workflow jobs (see below). Here is an example of what
this file could contain.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">NX_LOCKDIRECTORY</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">nxserver</span><span class="o">/</span><span class="n">locks</span>
<span class="n">export</span> <span class="n">NX_LOCK</span><span class="o">=</span><span class="mi">10</span>
<span class="n">nxserver</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">nxserver</span>
</pre></div>
</div>
<p>Other commands, <em>e.g.</em>, to initialize a particular conda environment,
could be also be added to this file.</p>
</div></blockquote>
<p><strong>nxcommand.sh</strong></p>
<blockquote>
<div><p>A shell script that is used if jobs need to be wrapped before
submission to the job queue, <em>e.g.</em>, using <code class="docutils literal notranslate"><span class="pre">qsub</span></code>. Here is an
example, in which <code class="docutils literal notranslate"><span class="pre">nxsetup.sh</span></code> is run in order to initialize
NXRefine.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo `date` &quot;USER ${USER} JOB_ID ${JOB_ID}&quot;
source /path/to/parent/nxserver/nxsetup.sh
&lt;NXSERVER&gt;
</pre></div>
</div>
</div></blockquote>
<p><strong>task_list</strong></p>
<blockquote>
<div><p>A directory that contains files that implement a file-based FIFO
queuing system for server jobs.</p>
</div></blockquote>
<p><strong>locks</strong></p>
<blockquote>
<div><p>A directory that contains files that implement the
<a class="reference external" href="https://nexpy.github.io/nexpy/">nexusformat</a> file-locking system.
Locked files can be viewed, and removed if they are stale, using the
<code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">File</span> <span class="pre">Locks</span></code> dialog in the NeXpy <code class="docutils literal notranslate"><span class="pre">File</span></code> menu.</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The log files can be viewed using the <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">Server</span></code> dialog
and the settings file can be modified using the <code class="docutils literal notranslate"><span class="pre">Edit</span>
<span class="pre">Settings</span></code> dialog, both of which are located in the <code class="docutils literal notranslate"><span class="pre">Server</span></code>
menu added as a NeXpy plugin when NXRefine is installed.</p>
</div>
</div>
<div class="section" id="default-settings">
<h3>Default Settings<a class="headerlink" href="#default-settings" title="Permalink to this headline">¶</a></h3>
<p>The file, <code class="docutils literal notranslate"><span class="pre">settings.ini</span></code> in the server directory contains the default
settings for the server, the beamline, and the workflow. These values
can be changed, either by opening the “Edit Settings” dialog in the
NeXpy “Server” menu or at the command line using <code class="docutils literal notranslate"><span class="pre">nxsettings</span> <span class="pre">-i</span></code>.
Hitting the [Return] key keeps the current value.</p>
<div class="figure align-right" style="width: 30%">
<a class="reference internal image-reference" href="_images/server_settings.png"><img alt="_images/server_settings.png" src="_images/server_settings.png" style="width: 90%;" /></a>
</div>
<p>The right-hand figure shows an example of the first two sections of the
<code class="docutils literal notranslate"><span class="pre">settings.ini</span></code>. The other sections contain default values of the data
reduction parameters that can be customized for each experiment (see the
next section).</p>
<p><strong>Server Settings</strong>
The server settings are used by the workflow server, which is described
in a later section.</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p>The server type can either be <code class="docutils literal notranslate"><span class="pre">multicore</span></code> or <code class="docutils literal notranslate"><span class="pre">multinode</span></code>. The
only difference is that multinode servers have a list of defined
nodes, to which jobs may be submitted, so their names will also
be stored in the settings file. If jobs are submitted to a job
server, without needing to specify the node, or if all the jobs
are performed on the local machine, then the server type should
be <code class="docutils literal notranslate"><span class="pre">multicore</span></code>.</p>
</dd>
<dt class="field-even">cores</dt>
<dd class="field-even"><p>This sets the number of jobs that can be run simultaneously by
the server. Once reaching the limit, new jobs will only start as
old ones are finished.</p>
</dd>
<dt class="field-odd">concurrent</dt>
<dd class="field-odd"><p>This determines whether parallelized processes should be
used in the workflow. These speed up the computation, but
can be disabled if they cause issues with the server. Note
that this refers to whether multiple processes can be run
simultaneously, <em>e.g.</em>, in peaks searches, not whether
multiple jobs can be submitted to the server. Valid values
are <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd>
<dt class="field-even">run_command</dt>
<dd class="field-even"><p>This is a string that is prepended to any jobs that are
submitted to the server. It can contain a set of switches
in addition to the job submission command itself.</p>
</dd>
<dt class="field-odd">template</dt>
<dd class="field-odd"><p>In some systems, it is necessary to wrap the command that is
submitted to the server in a shell script. This is the name
of the script, which should be stored in the <code class="docutils literal notranslate"><span class="pre">nxserver</span></code>
directory. It should contain the string <code class="docutils literal notranslate"><span class="pre">&lt;NXSERVER&gt;</span></code>,
which is replaced by the job command.</p>
</dd>
<dt class="field-even">cctw</dt>
<dd class="field-even"><p>This is the path to the CCTW executable used to transform data
from instrumental coordinates to reciprocal space.</p>
</dd>
</dl>
<p><strong>Instrument Settings</strong>
The instrument settings are used to define the name of the instrument,
which is used to import a customized plugin for importing metadata,
and a set of paths defining the location of the raw and reduced data
locations.</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Installation</a><ul>
<li><a class="reference internal" href="#required-libraries">Required Libraries</a></li>
<li><a class="reference internal" href="#cctw">CCTW</a></li>
<li><a class="reference internal" href="#user-support">User Support</a></li>
<li><a class="reference internal" href="#initial-setup">Initial Setup</a><ul>
<li><a class="reference internal" href="#server-directory">Server Directory</a></li>
<li><a class="reference internal" href="#default-settings">Default Settings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="introduction.html"
                          title="previous chapter">Introduction</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="experiment.html"
                          title="next chapter">Experiments</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/installation.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="experiment.html" title="Experiments"
             >next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Ray Osborn.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>