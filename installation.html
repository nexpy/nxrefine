
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Installation &#8212; NXRefine 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Experiments" href="experiment.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="experiment.html" title="Experiments"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>Currently, NXRefine must be installed from source by cloning the
<a class="reference external" href="https://github.com/nexpy/nxrefine">NXRefine Git repository</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/nexpy/nxrefine.git
</pre></div>
</div>
<p>Then use standard Python tools to build and/or install a distribution
from within the source directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python -m build  # build a distribution
$ python -m pip install .  # install the package
</pre></div>
</div>
<p>In the near future, NXRefine will be uploaded to the PyPI server so that
it can be installed without downloading the source code.</p>
<div class="section" id="required-libraries">
<h2>Required Libraries<a class="headerlink" href="#required-libraries" title="Permalink to this headline">¶</a></h2>
<p>The following packages are listed as dependencies.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 26%" />
<col style="width: 74%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Library</p></th>
<th class="head"><p>URL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NeXpy</p></td>
<td><p><a class="reference external" href="https://github.com/nexpy/nexpy/">https://github.com/nexpy/nexpy/</a></p></td>
</tr>
<tr class="row-odd"><td><p>cctbx-base</p></td>
<td><p><a class="reference external" href="https://cci.lbl.gov/cctbx_docs/">https://cci.lbl.gov/cctbx_docs/</a></p></td>
</tr>
<tr class="row-even"><td><p>pyfai</p></td>
<td><p><a class="reference external" href="https://pyfai.readthedocs.io/">https://pyfai.readthedocs.io/</a></p></td>
</tr>
<tr class="row-odd"><td><p>sqlalchemy</p></td>
<td><p><a class="reference external" href="https://docs.sqlalchemy.org/">https://docs.sqlalchemy.org/</a></p></td>
</tr>
<tr class="row-even"><td><p>psutil</p></td>
<td><p><a class="reference external" href="https://psutil.readthedocs.io/.io/">https://psutil.readthedocs.io/.io/</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cctw">
<h2>CCTW<a class="headerlink" href="#cctw" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://sourceforge.net/projects/cctw/">CCTW</a> (Crystal Coordination
Transformation Workflow) is a C++ package written by Guy Jennings. It
is launched as a separate process by NXRefine, which uses the
experimental metadata to define the settings file used to define the
input and output grids. It has to be separately installed.</p>
</div>
<div class="section" id="user-support">
<h2>User Support<a class="headerlink" href="#user-support" title="Permalink to this headline">¶</a></h2>
<p>If you are interested in using this package, please contact Ray Osborn
(<a class="reference external" href="mailto:ROsborn&#37;&#52;&#48;anl&#46;gov">ROsborn<span>&#64;</span>anl<span>&#46;</span>gov</a>). Please report any bugs as a
<a class="reference external" href="https://github.com/nxrefine/nxrefine/issues">Github issue</a>, with
relevant tracebacks.</p>
</div>
<div class="section" id="initial-setup">
<h2>Initial Setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h2>
<p>In order to allow NXRefine to be used on machines with multiple users,
a directory is defined to store log files, task queues, and settings.
This directory can be initialized on the command line by the ‘nxserver’
command:</p>
<blockquote>
<div><p>$ nxserver -d /path/to/parent</p>
</div></blockquote>
<p>This will create a directory at <code class="docutils literal notranslate"><span class="pre">/path/to/parent/nxserver</span></code> containing
the files that are required by NXRefine server.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the supplied path already ends in <code class="docutils literal notranslate"><span class="pre">nxserver</span></code>, it will not
be appended.</p>
</div>
<p>All the files in the <code class="docutils literal notranslate"><span class="pre">nxserver</span></code> directory will have group read/write
permissions to allow them to be updated by multiple users in that group.</p>
<p>This also adds a hidden file to the home directory, containing the path
to the server directory, so that the server path can be read in future
login sessions. Each user should then issue the same command to store
the server directory in their own home directory. If the server
directory already exists, it is not touched. In principle, this only
needs to be run once, but it could be</p>
<p>NXRefine uses file-based locking to prevent corruption of data files.
This system is provided by the
<a class="reference external" href="https://nexpy.github.io/nexpy/">nexusformat package</a>, which defines
the directory to contain the lock files using the <code class="docutils literal notranslate"><span class="pre">NX_LOCKDIRECTORY</span></code>
environment variable. It is recommended that this directory be placed
within the server directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The NeXpy GUI has a settings file that can be used to define
the lock directory, but it is overridden by the environment
variable if it is defined. This allows system administrators
to set up a unique lock file directory for all their users.</p>
</div>
<div class="section" id="server-directory">
<h3>Server Directory<a class="headerlink" href="#server-directory" title="Permalink to this headline">¶</a></h3>
<p>Here is the structure of the <code class="docutils literal notranslate"><span class="pre">nxserver</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nxserver
├── nxserver.log
├── cpu1.log
├── cpu2.log
├── cpu3.log
├── settings.ini
├── nxcommand.sh
└── task_list
    ├── info
    └── q00000
└── locks
    ├── ...
    └── ...
</pre></div>
</div>
<ul>
<li><p><strong>nxserver.log</strong></p>
<p>This is a log file that records jobs submitted to the server queue.</p>
</li>
<li><p><strong>cpu1.log</strong>, <strong>cpu2.log</strong>, …</p>
<p>These are log files that contain the output of jobs running on the
server. The number depends on the number of simultaneous jobs that
are allowed on the server, which is defined by the settings file.</p>
</li>
<li><p><strong>settings.ini</strong></p>
<p>A file containing default settings used by the NXRefine package,
including server parameters, instrumental parameters, and parameters
used in the data reduction workflow. When a new experiment is set up,
a copy of these parameters is stored in the experiment directory (to
be described later), so that they can be customized if necessary.
These settings are described below.</p>
</li>
<li><p><strong>nxsetup.sh</strong></p>
<p>A shell script that could be used to initialize paths to the server
directory or environment variables used by NeXpy. This could be run
within a user’s <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file, or by other shell scripts used to
launch NXRefine workflow jobs (see below). Here is an example of what
this file could contain.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">NX_LOCKDIRECTORY</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">nxserver</span><span class="o">/</span><span class="n">locks</span>
<span class="n">export</span> <span class="n">NX_LOCK</span><span class="o">=</span><span class="mi">10</span>
<span class="n">nxserver</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">parent</span><span class="o">/</span><span class="n">nxserver</span>
</pre></div>
</div>
<p>Other commands, <em>e.g.</em>, to initialize a particular conda environment,
could be also be added to this file.</p>
</li>
<li><p><strong>nxcommand.sh</strong></p>
<p>A shell script that is used if jobs need to be wrapped before
submission to the job queue, <em>e.g.</em>, using <code class="docutils literal notranslate"><span class="pre">qsub</span></code>. Here is an
example, in which <code class="docutils literal notranslate"><span class="pre">nxsetup.sh</span></code> is run in order to initialize
NXRefine.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo `date` &quot;USER ${USER} JOB_ID ${JOB_ID}&quot;
source /path/to/parent/nxserver/nxsetup.sh
&lt;NXSERVER&gt;
</pre></div>
</div>
</li>
<li><p><strong>task_list</strong></p>
<p>A directory that contains files that implement a file-based FIFO
queuing system for server jobs.</p>
</li>
<li><p><strong>locks</strong></p>
<p>A directory that contains files that implement the
<a class="reference external" href="https://nexpy.github.io/nexpy/">nexusformat</a> file-locking system.
Locked files can be viewed, and removed if they are stale, using the
<code class="docutils literal notranslate"><span class="pre">Show</span> <span class="pre">File</span> <span class="pre">Locks</span></code> dialog in the NeXpy <code class="docutils literal notranslate"><span class="pre">File</span></code> menu.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The log files can be viewed using the <code class="docutils literal notranslate"><span class="pre">Manage</span> <span class="pre">Server</span></code> dialog
and the settings file can be modified using the <code class="docutils literal notranslate"><span class="pre">Edit</span>
<span class="pre">Settings</span></code> dialog, both of which are located in the <code class="docutils literal notranslate"><span class="pre">Server</span></code>
menu added as a NeXpy plugin when NXRefine is installed.</p>
</div>
</div>
</div>
<div class="section" id="server-settings">
<h2>Server Settings<a class="headerlink" href="#server-settings" title="Permalink to this headline">¶</a></h2>
<p>The file, <code class="docutils literal notranslate"><span class="pre">settings.ini</span></code> in the server directory contains settings for
the server, the beamline, and the workflow. These values can be changed,
either by opening the “Edit Settings” dialog in the NeXpy “Server” menu
or at the command line using <code class="docutils literal notranslate"><span class="pre">nxsettings</span> <span class="pre">-i</span></code>. Hitting the [Return] key
keeps the current value. Here are the parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ nxsettings -i

Default settings stored in /path/to/parent/nxserver


server Parameters
-------------------
type [multicore]:
cores [10]:
concurrent [False]:
run_command [qsub -q chess.q]:
template [/path/to/parent/nxserver/nxcommand.sh]:
cctw [cctw]:

instrument Parameters
-------------------
source [CHESS]:
instrument [QM2]:
raw_home [/nfs/chess/id4b]:
raw_path [raw6M]:
analysis_home [/nfs/chess/id4baux]:
analysis_path [nxrefine]:
experiment []:

NXRefine Parameters
-------------------
wavelength [0.3351]:
distance [511.312]:
geometry [default]:
phi [-5]:
phi_end [360]:
phi_step [-0.1]:
chi [0]:
omega [0]:
gonpitch [0]:
x [0]:
y [0]:
nsteps [3]:
frame_rate [10]:

NXReduce Parameters
-------------------
threshold [50000]:
min_pixels [10]:
first [10]:
last [3640]:
polar_max [10]:
monitor [monitor1]:
norm [15000]:
qmin [4]:
qmax [11]:
radius [0.2]:
</pre></div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Installation</a><ul>
<li><a class="reference internal" href="#required-libraries">Required Libraries</a></li>
<li><a class="reference internal" href="#cctw">CCTW</a></li>
<li><a class="reference internal" href="#user-support">User Support</a></li>
<li><a class="reference internal" href="#initial-setup">Initial Setup</a><ul>
<li><a class="reference internal" href="#server-directory">Server Directory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#server-settings">Server Settings</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="introduction.html"
                          title="previous chapter">Introduction</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="experiment.html"
                          title="next chapter">Experiments</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/installation.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="experiment.html" title="Experiments"
             >next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">NXRefine 0.1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Installation</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Ray Osborn.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>